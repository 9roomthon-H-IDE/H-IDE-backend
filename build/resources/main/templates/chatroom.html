<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
    <style>
        /* 스타일링: 왼쪽 정렬 */
        .message-left {
            text-align: left;
            margin-left: 10px;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-bottom: 5px;
            clear: both;
            width: 50%;
        }

        /* 스타일링: 오른쪽 정렬 */
        .message-right {
            text-align: right;
            margin-right: 10px;
            padding: 5px;
            background-color: #d3edf8;
            border-radius: 5px;
            margin-bottom: 5px;
            clear: both;
            width: 50%;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div id="chat">
    <ul id="messages"></ul>
    <input type="text" id="message" autocomplete="off"/>
    <button onclick="sendMessage()">Send</button>
    <input type="text" id="searchQuery" autocomplete="off"/>
    <button onclick="searchMessages()">Search</button>
</div>

<script>
    var stompClient = null;
    var myUsername = '';

    //socket 통신
    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            var loginId = extractLoginId(frame); //유저정보
            myUsername = loginId
            if (loginId) {
                // 로그인 되었음을 알리는 메시지
                stompClient.send("/pub/chat.login", {}, loginId);
                // "user "
            }

            // WebSocket 구독
            stompClient.subscribe('/sub/chat', function (messageOutput) {
                console.log("Received messageOutput:", messageOutput);

                let message;

                message = JSON.parse(messageOutput.body); // JSON 파싱 시도

                console.log("Processed message:", message);
                showMessage(message);
            });
        });
    }

    // frame이라는 stomp header에서 값 추출
    function extractLoginId(frame) {
        var headers = frame.headers;

        if (headers && headers['user-name']) {
            return headers['user-name'];
        }
        return null;
    }

    // message 보내기
    function sendMessage() {
        var message = document.getElementById('message').value;
        stompClient.send("/pub/chat.sendMessage", {}, JSON.stringify({'content': message}));
    }

    function showMessage(message) {
        var response = document.getElementById('messages');
        var li = document.createElement('li');

        // 메시지를 보낸 사람이 자신인지 확인하여 CSS 클래스를 다르게 적용
        if (message.user.loginId === myUsername) {
            li.className = 'message-right';
        } else {
            li.className = 'message-left';
        }

        li.appendChild(document.createTextNode(message.content));
        response.appendChild(li);
    }


    // 나중에 다시 구현 ㅠ
    function searchMessages() {
        var query = document.getElementById('searchQuery').value;
        var url = new URL('/chat/search', window.location.origin); // API 엔드포인트로 변경
        url.searchParams.append('query', query);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(messages => {
                var response = document.getElementById('messages');
                response.innerHTML = ''; // 기존 메시지 삭제

                messages.forEach(message => {
                    console.log(message)
                    var li = document.createElement('li');

                    // 메시지를 보낸 사람이 자신인지 확인하여 CSS 클래스를 다르게 적용
                    if (message.user.loginId === myUsername) {
                        li.className = 'message-right';
                    } else {
                        li.className = 'message-left';
                    }

                    var content = document.createElement('span');
                    content.textContent = message.content; // 메시지 내용 추가
                    li.appendChild(content);

                    response.appendChild(li);
                });
            })
            .catch(error => console.error('Error fetching messages:', error));
    }
    // 커넥트 실행
    connect();
</script>
</body>
</html>